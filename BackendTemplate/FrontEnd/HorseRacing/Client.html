<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Đua ngựa</title>
	<script src="BGEngine.js"></script>
</head>

<body>
	<canvas id="myCanvas" style="border:1px solid #000000;"></canvas>
	<script>
		const canvas = document.getElementById("myCanvas");
		canvas.width = window.innerWidth - 22;
		canvas.height = window.innerHeight - 22;
		gameEngine.setupCanvas(canvas);
		gameEngine.isDevelop = true;


		class Ultilities {
			static createBtn = (text = 'Button', _event = null, _top = 0, _left = 0, _position = '') => {
				const btn = document.createElement('button');
				btn.innerText = text;
				if (_position == '')
					btn.style.position = 'absolute';
				else
					btn.style.position = _position;
				btn.style.top = `${_top}px`;
				btn.style.left = `${_left}px`;
				// btn.addEventListener('click', _event != null ? _event : () => {
				btn.addEventListener('click', _event != null ? _event : () => {
					if (_event != null)
						_event();
					btn.remove();
				})
				document.body.appendChild(btn);
				return btn;
			}

			static lerp(start, end, t) {
				const val = (1 - t) * start + t * end;
				return val;
			}

			static getWinIds(index) {
				const result = {
					first: -1,
					second: -1,
				}
				switch (index) {
					case 0:
						result.first = 0;
						result.second = 5;
						break;
					case 1:
						result.first = 1;
						result.second = 5;
						break;
					case 2:
						result.first = 2;
						result.second = 5;
						break;
					case 3:
						result.first = 3;
						result.second = 5;
						break;
					case 4:
						result.first = 4;
						result.second = 5;
						break;
					case 5:
						result.first = 0;
						result.second = 4;
						break;
					case 6:
						result.first = 1;
						result.second = 4;
						break;
					case 7:
						result.first = 2;
						result.second = 4;
						break;
					case 8:
						result.first = 3;
						result.second = 4;
						break;
					case 9:
						result.first = 0;
						result.second = 3;
						break;
					case 10:
						result.first = 1;
						result.second = 3;
						break;
					case 11:
						result.first = 2;
						result.second = 3;
						break;
					case 12:
						result.first = 0;
						result.second = 2;
						break;
					case 13:
						result.first = 1;
						result.second = 2;
						break;
					case 14:
						result.first = 0;
						result.second = 1;
						break;
					default:
						console.log("Tra cai gi ve vay");
						break;
				}
				return result;
			}
		}
		class F {
			static CMD = "cmd";
			static OLD_STATE = "oS";
			static NEW_STATE = "nS";
			static GAME_DETAILS = "gDs";
			static USER_ID = "uid";
			static USERNAME = "u";
			static MONEY = "m";
			static AVATAR = "a";
			static GENDER = "g";
			static PLAYER = "p";
			static TYPE = "t";
			static CODE = "c";
			static BETTING = "b";
			static CARDS = "cs";
			static FROM_PLAYER = "fP";
			static TO_PLAYER = "tP";
			static PLAYER_STATE = "pS";
			static MONEY_EXCHANGE = "mX";
			static PLAYERS = "ps";
			static GROUP_NAME = "G";
			static ROOM_ID = "rid";
			static ROOM_NAME = "rn";
			static MIN_MONEY = "mM";
			static ROOMS = "rs";
			static GAME_TYPE = "gT";
			static USER_COUNT = "uC";
			static MAX_USER = "Mu";
			static TOTAL_USER_COUNT = "tUC";
			static GAME_STATE = "gS";
			static IS_ROOM_MASTER = "C"; // captain
			static REASON = "rea";
			static POSITION = "sit"; // vi tri
			static REMAINING_TIME = "rmT";
			static USER_ASSETS = "As";
			static BROADCAST_MESSAGE = "bcm";
			static ACCESS_TOKEN = "accessToken";
			static MERCURY_ACCESS_TOKEN = "mercury:accessToken";
			static USERS = "us";
			static DATA = "d";
			static DISPLAY_NAME = "dn";
			static NEXT_CMD = "nCmd";
			static LOST_MONEY = "lm";
			static LAST_ROOM = "lr";
			static READY = "r";
			static TIME = "T";
			static PLAYING = "pi";
			static RECONNECT = "re";
			static GAME_ID = "gid";
			static SERVER_ID = "sid";
			static ZONE_NAME = "zn";
			static ID = "id";
			static HAZELCAST = "hazelcast";
			static LAST_DISCARDS = "ldc";
			static ASSET_ID = "aid";
			static _ID = "_id";
			static SEQ = "seq";
			static MUST_UPDATE_USERNAME = "muu";
			static ID_PRODUCER = "idProducer";
			static FROM_USER = "fu";
			static ROOM_INFO = "ri";
			static SUBSCRIBLE_INVITE = "subi";
			static PLATFORM_ID = "pid";
			static LIST_PLAYING = "lpi";
			static PHONE = "ph";
			static PHONE_VERIFIED = "pvr";
			static CURRENT_PLAYER = "cP";
			static PREV_USER_ID = "puid";
			static TIME_FOR_TURN = "tft";
			static MIN_MONEY_BUY_IN = "mMBI";
			static MAX_MONEY_BUY_IN = "MMBI";
			static REAL_MONEY = "rM";
			static POTS = "pots";
			static WINNERS = "wns";
			static IS_WINNER = "iw";
			static MESSAGE = "mgs";
			static SUCCESS = "scc";
			static MAX_MONEY_CREATE_ROOM = "Mmcr";
			static MIN_MONEY_CREATE_ROOM = "mmcr";
			static MAX_BETTING = "mB";
			static NAME = "name";
			static UNREAD = "ur";
			static NEW_ANNOUNCE = "na";
			static ACTIVE_MESSAGE = "am";
			static TIME_FOR_END_GAME = "tfeg";
			static VALUE = "v";
			static BALANCE = "ba";
			static JAR = "jar";
			static JAR_ID = "jid";
			static ENABLE_JAR_OF_THREE_CARDS = "ejotc";
			static JARS = "js";
			static BETTINGS = "bs";
			static IS_JOIN = "iJ";
			static URL = "url";
			static VERIFY_MESSAGE = "vm";
			static GROUP_ID = "grI";
			static DEFAULT_BETTING = "dfB";
			static TIME_FOR_READY = "tFR";
			static TIME_FOR_START = "tFS";
			static TIME_FOR_DEAL_CARD = "tFDC";
			static TURN_REMAINING_TIME = "tRMT";
			static IS_READY = "isR";
			static ENTRY_ID = "eid";
			static IS_BOT = "ib";
			static GAME_MODE = "gM";
			static METADATA = "rMt";
			static LOAN_MONEY = "loan";
			static MAX_LOAN = "mL";
			static IS_SHOW = "is";
			static IS_FRIEND = "iF";
			static TO_USER = "tu";
			static FRIENDS = "fris";
			static CHANNELS = "chs";
			static CHANNEL = "ch";
			static TIMESTAMP = "tst";
			static TOURNAMENT_INFO = "tournamentInfo";
			static IS_TOURNAMENT = "iTmt";
			static CHAT_HISTORY = "cH";
			static FROM_USERNAME = "fun";
			static TO_USERNAME = "tun";
			static TIME_FOR_BETTING = "tfb";
			static ROOM_BETTINGS = "rbs";
			static TIME_FOR_BOOKING = "tfb";
			static INCOGNITO = "inc";
			static PASSWORD = "pwd";
			static HAS_PASSWORD = "hpwd";
			static MAX_BET = "MB";
			static JACKPOTS = "Js";
			static HUGE = "hg";
			static DRAW_ID = "d";
			static COUNT_DOWN = "c";
			static CCU_GAMES = "cgs";
			static CCU = "ccu";
			static VERIFIED_BANK_ACCOUNT = "vba";
			static LIMIT = "L";
			static SKIP = "S";
			static SKIP_LOGOUT_MESSAGE = "slom";
			static BRAND = "br";
		}
		class CMD {
			static C_JOIN_GAME = 10001;
			static S_JOIN_GAME = 10002;
			static S_PLAYER_JOIN_GAME = 10003;

			static C_LEFT_GAME = 10011;
			static S_LEFT_GAME = 10012;
			static S_PLAYER_LEFT_GAME = 10013;


			static C_ADD_BET = 20001;
			static S_ADD_BET = 20002;
			static S_ADD_BET_Invalid = 20003;
			static S_PLAYER_ADD_BET = 20009;

			static S_FINISH_GAME = 20900;
		}

		class BasicWebsocket {
			#websocket;
			constructor() {
				this.idCMD = 0;
			}
			start(_ip, _port) {
				console.log("*********************************************************************************");
				this.#websocket = new WebSocket("ws://" + _ip + ":" + _port + "/websocket");
				let _currentBasicWebsocket = this;
				this.#websocket.onopen = function (e) {
					console.log("BasicWebsocket kết nối đến [" + _ip + ":" + _port + "] thành công");
					_currentBasicWebsocket.send([1, "Ri", Math.random().toString(36).slice(2), "password", null]);
				};
				this.#websocket.onclose = function (event) {
					console.log("Đóng kết nối BasicWebsocket");
				};

				this.#websocket.onmessage = function (event) {//
					gameEngine.lastTimeWebsocket = Date.now();
					let _data = event.data;
					if (_data instanceof ArrayBuffer) {// binary frame
						console.log("BasicWebsocket receive bytearray : " + _data);
					} else {// text frame
						//console.log("BasicWebsocket receive string : " + _data);
						let jsonReceive = JSON.parse(_data);
						if (jsonReceive[0] == 1) {
							_currentBasicWebsocket.username = jsonReceive[3];
							gameEngine.username = jsonReceive[3];
							console.log("Login vào zone thành công với username : " + _currentBasicWebsocket.username);
							if (_currentBasicWebsocket.onSuccess)
								_currentBasicWebsocket.onSuccess();
						} else if (jsonReceive[0] == 5) {
							let _mgF = jsonReceive[1];
							//console.log("Nhận message trong plugin CMD : " + jsonReceive[1].cmd);
							switch (jsonReceive[1].cmd) {
								case CMD.S_ADD_BET:
									console.log("Lỗi bet");
									_currentBasicWebsocket.onBetError(_mgF[F.ID], _mgF[F.CODE]);
									break;
								case CMD.S_PLAYER_ADD_BET:
									_currentBasicWebsocket.onPlayerBet(_mgF[F.USERNAME], _mgF[F.ID], _mgF[F.LOST_MONEY], _mgF[F.MONEY], _mgF[F.BETTING]);
									break;
								case CMD.S_FINISH_GAME:
									//if(_mgF[F.MONEY])
									_currentBasicWebsocket.onFinishGame(_mgF[F.ID], _mgF[F.WINNERS], _mgF[F.MONEY], _mgF[F.NEW_ANNOUNCE]);
									//else
									//_currentBasicWebsocket.onFinishGame(_mgF[F.ID],0,0,_mgF[F.NEW_ANNOUNCE]);
									break;
								case 20000:
									_currentBasicWebsocket.onGameInfo(_mgF[F.MONEY], _mgF[F.NEW_STATE], _mgF[F.BETTING], _mgF[F.TIME], _mgF[F.TIME_FOR_TURN], _mgF[F.OLD_STATE]);
									break;
								default:
									console.log("Chưa xử lý CMD : " + jsonReceive[1].cmd);
							}
						} else {

						}
					}
				};

				this.#websocket.onerror = function (error) {
					console.log("BasicWebsocket get error " + error);
				};

				console.log("*********************************************************************************");
			}

			isRunning() { return this.#websocket && (this.#websocket.readyState == WebSocket.OPEN || this.#websocket.readyState == WebSocket.CONNECTING); }/*CONNECTING(0) - OPEN(1) - CLOSING(2) - CLOSED(3)*/
			send(_message) {
				//console.log("=====>BasicWebsocket send : " + JSON.stringify(_message));
				this.#websocket.send(JSON.stringify(_message));
			}
			doBet(_index, _money) {
				let messageSending = {};
				messageSending["cmd"] = CMD.C_ADD_BET;
				messageSending[F.ENTRY_ID] = this.idCMD++;
				messageSending[F.ID] = _index;
				messageSending[F.BETTING] = _money;
				this.send([6, "Ri", "duanguaPlugin", messageSending]);
			}

			release() { this.#websocket.close(); }
		}
		var basicWS = new BasicWebsocket();

		class SceneLogin extends GameScene{
			constructor() { super("Scene Login"); }
			onInit(){
				this.targetText = {
					currentTarget: 0,
					username: "Richard",
					password: "Richard"
				}
				this.loginTable = {
					x: canvas.width/2,
					y: canvas.height/2,
					width: 236,
					height: 296,
					backgroundImg : new Image()
				}
				this.loginTable.backgroundImg.src = '../UI/LoginScene/LoginBackground.png';

				this.loginInputField = {
					img: new Image(),
					width: 211,
					height: 51
				}
				this.inputFieldOffset = {
					x: this.loginTable.x - this.loginTable.width/2 + 13,
					y: this.loginTable.y - this.loginTable.height/2 + 80, // + this.loginInputField.height + 5
				}
				this.loginInputField.img.src = '../UI/LoginScene/FiedBackground.png';

				this.loginButton = {
					img: new Image(),
					width: 67,
					height: 41
				}
				this.loginButtonOffset = {
					x: (this.loginTable.x - this.loginTable.width/2 + this.loginTable.width) - this.loginButton.width - 15,
					y: (this.loginTable.y - this.loginTable.height/2 + this.loginTable.height) - this.loginButton.height - 15,
				}
				this.loginButton.img.src = '../UI/LoginScene/LoginButton.png';
			}
			onDraw(){
				// Background
				gameEngine.ctx.drawImage(
					this.loginTable.backgroundImg,
					this.loginTable.x - this.loginTable.width/2,
					this.loginTable.y - this.loginTable.height/2,
					this.loginTable.width, this.loginTable.height
				);

				// Input field
				gameEngine.ctx.drawImage(
					this.loginInputField.img,
					this.inputFieldOffset.x,
					this.inputFieldOffset.y,
					this.loginInputField.width, this.loginInputField.height
				);

				gameEngine.ctx.fillStyle = "black";
				gameEngine.ctx.font = "25px sans-serif";
				// 13 char is max of 25px
				gameEngine.ctx.fillText(
					this.targetText.username,
					this.inputFieldOffset.x + 15,
					this.inputFieldOffset.y + 32,
				);

				gameEngine.ctx.drawImage(
					this.loginInputField.img,
					this.inputFieldOffset.x,
					this.inputFieldOffset.y + this.loginInputField.height + 5,
					this.loginInputField.width, this.loginInputField.height
				);

				gameEngine.ctx.fillText(
					this.targetText.password,
					this.inputFieldOffset.x + 15,
					this.inputFieldOffset.y + this.loginInputField.height + 5 + 32,
				);

				// Button login
				gameEngine.ctx.drawImage(
					this.loginButton.img,
					this.loginButtonOffset.x,
					this.loginButtonOffset.y,
					this.loginButton.width, this.loginButton.height
				);
			}
			onKeyDown(event){
				var name = event.key;
				var code = event.code;
				if (name == "Escape" || name == "`" || name == "Tab" || name == "Meta" ||
					name == "Alt" || name == "Control" || name == "Shift" || name == "Enter" ||
					name == "Delete" || name == "End" ||
					name == "PageDown" || name == "PageUp" || name == "Home" || name == "NumLock" ||
					name == "/" || name == "*" || name == "-" || name == "+")
						return;
				

				console.log("onKeyDown : " + name + " = " + code);

				if (this.targetText.currentTarget == 0){
					if (name == "Backspace")
						this.targetText.username = this.targetText.username.slice(0, -1);
					else
						this.targetText.username += name;
				}else if (this.targetText.currentTarget == 1){
					if (name == "Backspace")
						this.targetText.username = this.targetText.username.slice(0, -1);
					else
						this.targetText.password += name;
				}
			}
			onClick(){
				// 0 = username, 1 = password
				if (this.inputFieldOffset.x <= this.mouseX &&
					this.mouseX <= (this.inputFieldOffset.x + this.loginInputField.width) &&
					this.inputFieldOffset.y <= this.mouseY &&
					this.mouseY <= (this.inputFieldOffset.y + this.loginInputField.height)){
						this.targetText.currentTarget = 0;
				}else if (this.inputFieldOffset.x <= this.mouseX &&
					this.mouseX <= (this.inputFieldOffset.x + this.loginInputField.width) &&
					(this.inputFieldOffset.y  + this.loginInputField.height + 5) <= this.mouseY &&
					this.mouseY <= (this.inputFieldOffset.y + this.loginInputField.height + this.loginInputField.height + 5)){
						this.targetText.currentTarget = 1;
				}else if (this.loginButtonOffset.x <= this.mouseX &&
					this.mouseX <= (this.loginButtonOffset.x + this.loginButton.width) &&
					this.loginButtonOffset.y <= this.mouseY &&
					this.mouseY <= (this.loginButtonOffset.y + this.loginButton.height)){
						console.log(`Username: ${this.targetText.username} - Password: ${this.targetText.password}`);
						gameEngine.changeScene(new SceneLobby);
				}
			}
		}
		class SceneLobby extends GameScene{
			constructor() { super("Scene Lobby"); }
			onInit(){
				this.horseRacing = {
					iconImg: new Image(),
					x: canvas.width/2,
					y: canvas.height/2,
					width: 256,
					height: 256,
				};
				this.horseRacingAvtOffset = {
					x: this.horseRacing.x - this.horseRacing.width/2,
					y: this.horseRacing.y - this.horseRacing.height/2
				}
				this.horseRacing.iconImg.src = '../UI/LoginScene/GameAvt.png';
			}
			onDraw(){
				gameEngine.ctx.drawImage(
					this.horseRacing.iconImg,
					this.horseRacingAvtOffset.x,
					this.horseRacingAvtOffset.y,
					this.horseRacing.width, this.horseRacing.height
				);
			}
			onClick(){
				if (this.horseRacingAvtOffset.x <= this.mouseX &&
					this.mouseX <= (this.horseRacingAvtOffset.x + this.horseRacing.width) &&
					this.horseRacingAvtOffset.y <= this.mouseY &&
					this.mouseY <= (this.horseRacingAvtOffset.y + this.horseRacing.height)){
						gameEngine.changeScene(new BetScene);
					}
			}
		}
		class SceneGamePlay extends GameScene {
			constructor() { super("aaaaaa"); }
			onInit() {
				Ultilities.createBtn('Scene Bet', () => {
					gameEngine.changeScene(new BetScene());
					console.log("aaaaaa");
				});
				this.img = new Image();
				this.background = new Image();
				this.background.src = '../UI/GameScene/map/range.png';
				this.startBackground = new Image();
				this.startBackground.src = '../UI/GameScene/map/line-start-6.png';
				this.endBackground = new Image();
				this.endBackground.src = '../UI/GameScene/map/line-finish.png';
				this.backgroundPosition = 0;
				this.finishLinePos = 0;
				this.startPosition = 0;
				this.startDraw = (canvas.height / 2) - 129 * 1.5;
				this.backgroundSpeed = 1;
				this.currentBGPos = 0;
				this.isRace = false;
				this.isWaitToFinish = false;
				this.isFinishGame = false;
				this.isHaveResult = false;
				this.secondHorseId = 2;
				this.firstHorseId = 1;

				// Horse Data
				// this.horseSpeed = 0.005;
				this.horseSpeed = 0.001;
				this.rankPosition = [50, 100, 150, 200, 250, 300, 350, 400, 450];
				this.horeseRank = [];
				this.currentHorsePos = [];
				this.idleAnim = [];
				this.runAnim = [];

				for (let i = 0; i < 6; i++) {
					this.horeseRank.push(0);
					this.currentHorsePos.push(0);

					this.idleAnim.push(new GameSprite(75));
					this.runAnim.push(new GameSprite(40));

					for (let k = 0; k < 7; k++) {
						this.idleAnim[i].addAnimation(`../UI/Animation/Idle/128x128/Horse_${i + 1}/Idle_Frame${k + 1}.png`, k);
					}

					for (let g = 0; g < 11; g++) {
						this.runAnim[i].addAnimation(`../UI/Animation/Run/128x128/Horse_${i + 1}/Run_Frame${g + 1}.png`, g);
					}
				}

				this.backgroundCountX = canvas.width / 194 + 1;
				this.backgroundCountY = 3;

				// Time count down to race
				this.timeCountDown = Date.now();
			}
			onUpdate() {
				//console.log("Đang ở trong Scene("+this.sceneName+") |||||| "+gameEngine.FPS);
				gameEngine.ctx.strokeStyle = "yellow";
				gameEngine.ctx.beginPath();
				gameEngine.ctx.moveTo(10, 45);
				gameEngine.ctx.lineTo(window.innerWidth - 32, 45);
				// Make the line visible
				gameEngine.ctx.stroke();
				gameEngine.ctx.strokeStyle = "blue";

				gameEngine.ctx.fillStyle = "red";
				gameEngine.ctx.fillRect(0, 540, 1080, 1);

				if (this.isWaitToFinish === false) {
					if (this.isRace === false) {
						const countdownTime = 3;
						const currentTime = Date.now();
						const timeRemaining = Math.max(0, countdownTime * 1000 - (currentTime - this.timeCountDown));
						const countdownNumber = Math.ceil(timeRemaining / 1000);
						const cdw = window.innerWidth - 22;
						const cdh = window.innerHeight - 22;


						if (countdownNumber > 0) {

							const numberImage = new Image();
							numberImage.src = `../UI/GameScene/num${countdownNumber}.png`;
							numberImage.onload = () => {
								gameEngine.ctx.fillStyle = "rgba(0, 0, 0, 0.8)";
								gameEngine.ctx.fillRect(0, 0, cdw, cdh);
								gameEngine.ctx.drawImage(numberImage, (canvas.width / 2) - 100, (canvas.height / 2) - 200);
							};
						}

						if (timeRemaining <= 0) {
							this.isRace = true;
							this.timeCountDown = Date.now();
							// TODO: force add horse rank here
						}
					} else {
						if (this.isHaveResult === false) {
							const arr = this.runAnim[0].randomRank(this.horeseRank);
							if (arr !== null) {
								this.horeseRank = arr;
							}
						}
					}
				}


				// this.ctx.fillStyle = "#FFA500";
				// this.ctx.fillText("👏 FPS : "+gameEngine.FPS, 200, 200);
			}
			onDraw() {
				for (let k = 0; k < this.backgroundCountY; k++) {
					for (let i = 0; i < 150; i++) {
						const position = this.background.width * i + this.currentBGPos;
						if ((-194) <= position && position <= canvas.width) {
							gameEngine.ctx.drawImage(
								this.background,
								position,
								this.startDraw + this.background.height * k);
						}
					}
				}

				// 214x517 is size X of the background
				if ((-this.startBackground.width) <= this.currentBGPos && this.currentBGPos <= canvas.width) {
					// Draw startline
					gameEngine.ctx.drawImage(
						this.startBackground,
						this.currentBGPos,
						this.startDraw);
				}

				if (this.isHaveResult) {
					gameEngine.ctx.drawImage(
						this.endBackground,
						canvas.width + this.finishLinePos,
						this.startDraw);
				}


				if (this.isRace) {
					for (let i = 0; i < 6; i++) {
						const horsePos = Ultilities.lerp(this.currentHorsePos[i], this.rankPosition[this.horeseRank[i]], this.horseSpeed);
						this.currentHorsePos[i] = horsePos;
						this.runAnim[i].draw(horsePos, this.startDraw - 64 + 64 * i, this.isFinishGame);
					}

					if (this.isWaitToFinish == false) {
						if (Date.now() - this.timeCountDown >= 5000) {
							this.timeCountDown = Date.now();

							if (this.isHaveResult) {
								this.isWaitToFinish = true;
							} else {
								console.log("Cheat horse win here");
								const arr = this.runAnim[1].randomRank(this.horeseRank, this.firstHorseId, this.secondHorseId, true);
								this.horeseRank = arr;
								this.isHaveResult = true;
							}
						}
					} else {
						// Finish game -> stop bg and horse move foward
						if (Date.now() - this.timeCountDown >= 2000) {
							this.backgroundSpeed = 0;
							this.isRace = false;
							this.horseSpeed = 1;
							console.log("Finish game, STOP race: this.isRace = false");
						}
						this.finishLinePos -= this.backgroundSpeed;
					}
					this.currentBGPos -= this.backgroundSpeed;
				} else {

					if (this.isWaitToFinish) {
						for (let i = 0; i < 6; i++) {
							this.currentHorsePos[i] += this.horseSpeed;
							this.runAnim[i].draw(this.currentHorsePos[i], this.startDraw - 64 + 64 * i, this.isFinishGame);
						}

						if (this.isFinishGame == false) {
							if (this.currentHorsePos[this.secondHorseId] + this.runAnim[this.firstHorseId].img[this.runAnim[this.firstHorseId].currentFrame].width >= (canvas.width + this.finishLinePos)) {
								this.isFinishGame = true;
								this.horseSpeed = 0;
								this.timeCountDown = Date.now();
							}
						}
					} else {
						for (let i = 0; i < 6; i++) {
							this.idleAnim[i].draw(0, this.startDraw - 64 + 64 * i, this.isFinishGame);
						}
					}
				}
				if (this.isFinishGame) {
					const popupWidth = window.innerWidth - 22;
					const popupHeight = window.innerHeight - 22;
					gameEngine.ctx.fillStyle = "rgba(0, 0, 0, 0.8)";
					gameEngine.ctx.fillRect(0, 0, popupWidth, popupHeight);

					// Vẽ ngựa thắng
					const winnerHorseImage = new Image();
					winnerHorseImage.src = `../UI/BetScene/HorseAvatar/Avatar/Horse_${this.firstHorseId + 1}.png`;
					gameEngine.ctx.drawImage(
						winnerHorseImage,
						canvas.width / 2 - canvas.width / 4 - 150 / 2,
						canvas.height / 2 - 150 / 2,
						150, 150);

					const goldMedal = new Image();
					goldMedal.src = `../UI/BetScene/HorseAvatar/Avatar/1st.png`;
					gameEngine.ctx.drawImage(
						goldMedal,
						canvas.width / 2 - canvas.width / 4 - 150 / 2 + 150,
						canvas.height / 2 - 150 / 2,
						193 / 2, 150);

					// Vẽ ngựa nhì
					const secondHorseImage = new Image();
					secondHorseImage.src = `../UI/BetScene/HorseAvatar/Avatar/Horse_${this.secondHorseId + 1}.png`;
					gameEngine.ctx.drawImage(
						secondHorseImage,
						canvas.width / 2 + canvas.width / 4 - 150 / 2,
						canvas.height / 2 - 150 / 2,
						150, 150);
					const silvelMedal = new Image();
					silvelMedal.src = `../UI/BetScene/HorseAvatar/Avatar/2nd.png`;
					gameEngine.ctx.drawImage(
						silvelMedal,
						canvas.width / 2 + canvas.width / 4 - 150 / 2 + 150,
						canvas.height / 2 - 150 / 2,
						193 / 2, 150);

					gameEngine.ctx.fillStyle = "white";
					gameEngine.ctx.font = "40px Ariel";
					gameEngine.ctx.fillText(
						`${this.firstHorseId + 1} - ${this.secondHorseId + 1}`,
						canvas.width / 2,
						canvas.height / 2);

					if (Date.now() - this.timeCountDown >= 3500) {
						gameEngine.changeScene(new BetScene());
					}
				}
			}
		}

		class GameSprite {
			constructor(_animationRate) {
				this.img = [];
				this.timeAnimation = Date.now();
				this.currentFrame = 1;
				this.animationRate = _animationRate;
				this.ramdonRankRate = Date.now();
			}

			addAnimation(url, index) {
				this.img[index] = new Image();
				this.img[index].src = url;
			}

			draw(_x, _y, _isStopGame) {
				if (_isStopGame == false) {
					if (Date.now() - this.timeAnimation > this.animationRate) {
						this.timeAnimation = Date.now();
						if (this.currentFrame == this.img.length - 1)
							this.currentFrame = 1;
						else
							this.currentFrame++;
					}
				}

				gameEngine.ctx.drawImage(
					this.img[this.currentFrame],
					_x,
					_y,
					128, 128);
			}

			randomRank(_horseRank, first = -1, second = -1, force = false) {
				if (Date.now() - this.ramdonRankRate > 3000 || force) {
					const arr = [];
					this.ramdonRankRate = Date.now();
					for (let i = 0; i < _horseRank.length; i++) {
						const val = this.getRandomInt(1, 8);
						// _horseRank[i] = val;
						arr[i] = val;

						if (force) {
							if (arr[i] == 7)
								arr[i] -= 1;
							else if (arr[i] == 8)
								arr[i] -= 2;
						}
					}
					if (force) {
						arr[first] = 8;
						arr[second] = 7;
					}

					let db = "";
					for (let i = 0; i < arr.length; i++)
						db += arr[i] + ", ";
					// console.log(db);
					return arr;
				}
				return null;
			}

			getRandomInt(min, max) {
				min = Math.ceil(min);
				max = Math.floor(max);
				const val = Math.floor(Math.random() * (max - min + 1)) + min;
				// console.log("Value: "+ val);
				return val;
			}
		}



		class BetScene extends GameScene {
			constructor() { super("BetScene"); }
			onInit() {
				this.sceneBackground = new Image();
				this.sceneBackground.src = `../UI/BetScene/Background.png`;
				this.scaleX = canvas.width/1920;
				this.scaleY = canvas.height/1080;

				console.log(`Width ${canvas.width}, Height ${canvas.height} ScaleX ${this.scaleX}, ScaleY ${this.scaleY}`);
				console.log(canvas.width)

				this.timeChangeScene = Date.now();
				this.clientCountDown = Date.now() + 20000;
				this.img = [];
				for (let i = 1; i <= 8; i++) {
					this.img[i - 1] = new Image();
					this.img[i - 1].src = `../UI/BetScene/HorseAvatar/Background/BG_${i}.png`;
				}

				this.imgHorse = [];
				for (let i = 1; i <= 8; i++) {
					this.imgHorse[i - 1] = new Image();
					this.imgHorse[i - 1].src = `../UI/BetScene/HorseAvatar/Avatar/Horse_${i}.png`;
				}
				this.imgHorseValue = {
					width: 74 * this.scaleX,
					height: 70 * this.scaleY
				}

				this.clockBackground = new Image();
				this.clockBackground.src = '../UI/BetScene/Clock.png';

				this.imgCup = new Image();
				this.imgCup.src = '../UI/BetScene/Cup.png';

				this.imgCoin = new Image();
				this.imgCoin.src = '../UI/BetScene/UserCoin.png';

				this.userData = {
					username: "tienduong",
					gold: gameEngine.money
				}

				// 16:9 => 1090x640
				this.betTableOffset = {
					x: 50,
					y: 50,
					img: new Image(),
					// width: 940,
					// height: 470,
					width: 1090 * this.scaleX,
					height: 535 * this.scaleY,
					betPoint: [],
					ODDs: [],
					currentPlayerInTable: 0,
					playerData: []
				};
				this.betTableOffset.img.src = '../UI/BetScene/BetTableBackground.png';
				this.horseContainerBG = {
					width: 175 * this.scaleX,
					height: 86 * this.scaleY,
				}

				for (let i = 0; i < 15; i++) {
					this.betTableOffset.betPoint.push(0);
				}

				this.betTableOffset.ODDs.push(50);
				this.betTableOffset.ODDs.push(3);
				this.betTableOffset.ODDs.push(80);
				this.betTableOffset.ODDs.push(1000);
				this.betTableOffset.ODDs.push(265);
				this.betTableOffset.ODDs.push(179);
				this.betTableOffset.ODDs.push(1);
				this.betTableOffset.ODDs.push(300);
				this.betTableOffset.ODDs.push(205);
				this.betTableOffset.ODDs.push(111); //10
				this.betTableOffset.ODDs.push(333);
				this.betTableOffset.ODDs.push(444);
				this.betTableOffset.ODDs.push(555);
				this.betTableOffset.ODDs.push(666);
				this.betTableOffset.ODDs.push(777);

				this.betTableOffset.playerData.push({
					id: 0,
					userName: "longAoDen",
					gold: 3000000
				});

				this.betTableOffset.playerData.push({
					id: 1,
					userName: "Dove",
					gold: 3000
				});

				this.betTableOffset.playerData.push({
					id: 2,
					userName: "Sacchi",
					gold: 500000
				});

				this.betTableOffset.playerData.push({
					id: 3,
					userName: "WengBui",
					gold: 2000000
				});

				this.betTableOffset.playerData.push({
					id: 4,
					userName: "lozMap",
					gold: 500000
				});

				this.betTableOffset.playerData.push({
					id: 5,
					userName: "On",
					gold: 5000000
				});

				this.betTableOffset.playerData.push({
					id: 6,
					userName: "hamHip",
					gold: 100
				});

				this.betTableOffset.playerData.push({
					id: 7,
					userName: "Manax",
					gold: 350000
				});

				this.betTableOffset.playerData.push({
					id: 8,
					userName: "longAoDen",
					gold: 3000000
				});

				this.betTableOffset.playerData.push({
					id: 9,
					userName: "longAoDen",
					gold: 3000000
				});


				this.historyTableOffset = {
					x: canvas.width - 450 * this.scaleX,
					y: this.betTableOffset.y,
					img: new Image(),
					width: 350 * this.scaleX,
					height: 644 * this.scaleY,
					tiltle: 'HISTORY',
					content: [],
				};
				this.historyTableOffset.img.src = `../UI/BetScene/HorseAvatar/Background/HistoryBG.png`;
				this.historyTableOffset.content.push("2 - 3")
				this.historyTableOffset.content.push("3 - 2")
				this.historyTableOffset.content.push("4 - 2")
				this.historyTableOffset.content.push("1 - 3")

				this.userInfoOffset = {
					x: 50,
					y: canvas.height - 50 - 110,
					width: 400,
					height: 140,
				};

				this.horseOffset = 20 * this.scaleX;

				// Chips and holder
				// Holder size with 16:9: 1025, 165
				this.chipHoldingId = 1;
				this.imgChips = [];
				for (let i = 0; i < 27; i++) {
					this.imgChips[i] = new Image();
					this.imgChips[i].src = `../UI/BetScene/ChipsID/Chip_${i + 1}.png`;
				}
				this.imgArrows = {
					left: new Image(),
					right: new Image(),
					width: 90,
					height: 90
				}
				this.imgArrows.left.src = `../UI/BetScene/ArrowHolder.png`;
				this.imgArrows.right.src = `../UI/BetScene/ArrowHolderRight.png`;

				this.chipsData = [];
				let value = 1;
				for (let i = 0; i < 9; i++) {
					this.chipsData.push({
						id: 1 + i * 3,
						value: 1 * value
					});
					this.chipsData.push({
						id: 2 + i * 3,
						value: 2 * value
					});
					this.chipsData.push({
						id: 3 + i * 3,
						value: 5 * value
					});
					value = value * 10;
				}

				this.imgChipHolder = new Image();
				this.imgChipHolder.src = `../UI/BetScene/ChipHolder.png`;
				this.chipOffset = 20;
				this.holderOffset = {
					x: canvas.width * 0.3,
					y: canvas.height - 165 - 10,
					arrow: canvas.width * 0.3 + 30,
					chipStart: canvas.width * 0.3 + 120,
					chipEnd: 96 * 7 + this.chipOffset * 7,
					width: 1025,
					height: 165,
					chipSize: 96
				}
				this.chipAnimation = {
					scale: {
						speed: 0.01,
						value: 1.28,
						currentSize: this.holderOffset.chipSize,
						isScaleUp: true
					},
					move: {
						speed: 0.005,
						currentPosX: this.holderOffset.chipStart + this.chipOffset * this.chipHoldingId + this.holderOffset.chipSize * this.chipHoldingId,
						currentPosY: this.holderOffset.y + this.holderOffset.height / 5.5,
					},
					speedMove: 0.001,
				}
				this.moveChipToBet = {
					id: 1,
					speed: 0.01,
					chips: [] // chip have currentX and currentY to lerp, target X and target Y
				}
				this.slidePage = 0;
				this.pageValue = {
					maxPage: parseInt(27 / 7 + (27 % 7 >= 1 ? 1 : 0)),
					currentPageNumber: 1,
					valueEachPage: this.chipOffset * 7 + this.holderOffset.chipSize * 7,
					speedSlide: 1,
					currentSlidePagePos: 0
				}
			}
			onUpdate() {
				// if (gameEngine.isDevelop) {
				// 	if (Date.now() - this.timeChangeScene >= 5000) {
				// 		gameEngine.changeScene(new SceneGamePlay);
				// 	}
				// }
			}
			onDraw() {

				
				// betTable 874x460
				gameEngine.ctx.drawImage(
					this.sceneBackground,
					0, 0,
					canvas.width, canvas.height); //265x125

				gameEngine.ctx.drawImage(
					this.betTableOffset.img,
					this.betTableOffset.x, this.betTableOffset.y,
					this.betTableOffset.width, this.betTableOffset.height);

				// Draw background avatar and avatar horse
				let currentHorseId = 0;
				gameEngine.ctx.fillStyle = "white";
				gameEngine.ctx.font = `${45 * this.scaleX}px Ariel`;
				// 167x83 chưa offset
				for (let i = 0; i < 6; i++) {
					if (i == 0)
						continue;
					currentHorseId = i;

					gameEngine.ctx.drawImage(
						this.img[currentHorseId],
						this.betTableOffset.x + this.horseOffset,
						this.betTableOffset.y + this.horseContainerBG.height * i + this.horseOffset / 2,
						this.horseContainerBG.width, this.horseContainerBG.height);

					gameEngine.ctx.drawImage(
						this.imgHorse[currentHorseId],
						this.betTableOffset.x + 10*this.scaleX + this.horseOffset,
						this.betTableOffset.y + this.horseContainerBG.height * i + this.horseContainerBG.height/2 - this.imgHorseValue.height/2 + this.horseOffset / 2,
						this.imgHorseValue.width, this.imgHorseValue.height);

					gameEngine.ctx.fillText(
						`${currentHorseId}`,
						this.betTableOffset.x + this.horseOffset + this.horseContainerBG.width * 0.65,
						this.betTableOffset.y + this.horseContainerBG.height * i + this.horseOffset / 2 + this.horseContainerBG.height * 0.7,
					);
				}

				currentHorseId = 1;
				for (let i = 6; i > 1; i--) {
					gameEngine.ctx.drawImage(
						this.img[i],
						this.betTableOffset.x + this.horseOffset + this.horseContainerBG.width * currentHorseId,
						this.betTableOffset.y + this.horseOffset / 2,
						this.horseContainerBG.width, this.horseContainerBG.height); //265x125

					gameEngine.ctx.drawImage(
						this.imgHorse[i],
						this.betTableOffset.x + 10*this.scaleX + this.horseOffset + this.horseContainerBG.width * currentHorseId,
						this.betTableOffset.y + this.horseOffset / 2 + this.horseContainerBG.height/2 - this.imgHorseValue.height/2,
						this.imgHorseValue.width, this.imgHorseValue.height);

					gameEngine.ctx.fillText(
						`${i}`,
						this.betTableOffset.x + this.horseOffset + this.horseContainerBG.width * currentHorseId + this.horseContainerBG.width * 0.65,
						this.betTableOffset.y + this.horseOffset / 2 + this.horseContainerBG.height * 0.7,
					);

					currentHorseId++;
				}

				// Draw strock
				gameEngine.ctx.fillStyle = "green";
				const startX = this.betTableOffset.x + this.horseOffset + this.horseContainerBG.width
				const startY = this.betTableOffset.y + this.horseOffset / 2 + this.horseContainerBG.height
				// Bet table
				for (let i = 0; i < 5; i++) {
					for (let k = 0; k < 5 - i; k++) {
						gameEngine.ctx.fillRect(
							startX + this.horseContainerBG.width * i,
							startY + this.horseContainerBG.height * k,
							this.horseContainerBG.width,
							this.horseContainerBG.height);
					}
				}
				// Draw table
				gameEngine.ctx.fillStyle = "black";
				for (let i = 0; i < 5; i++) {
					for (let k = 0; k < 5 - i; k++) {
						gameEngine.ctx.fillRect(
							startX + (this.horseContainerBG.width - 3) * i + 2 * i + 2,
							startY + (this.horseContainerBG.height - 3) * k + (k * 2) + 2,
							this.horseContainerBG.width - 2,
							this.horseContainerBG.height - 2);
					}
				}

				// Draw other players
				if (this.betTableOffset.playerData.length > 0) {
					// Other players background
					gameEngine.ctx.fillStyle = "blue";
					for (let i = 0; i < 5; i++) {
						for (let j = 5 - i; j < 5; j++) {
							gameEngine.ctx.fillRect(
								startX + (this.horseContainerBG.width - 3) * i + 2 * i + 2,
								startY + (this.horseContainerBG.height - 3) * j + (j * 2) + 2,
								this.horseContainerBG.width - 2,
								this.horseContainerBG.height - 2);
						}
					}

					// Other players text background
					gameEngine.ctx.fillStyle = "white";
					for (let i = 0; i < 5; i++) {
						for (let j = 5 - i; j < 5; j++) {
							gameEngine.ctx.fillRect(
								startX + (this.horseContainerBG.width - 3) * i + 2 * i + 2 + (this.horseContainerBG.width - 2) / 3,
								(startY + (this.horseContainerBG.height - 3) * j + (j * 2) + 2 + 2) + 2,
								this.horseContainerBG.width * 0.62, 32,
							);

							gameEngine.ctx.fillRect(
								startX + (this.horseContainerBG.width - 3) * i + 2 * i + 2 + (this.horseContainerBG.width - 2) / 3,
								startY + (this.horseContainerBG.height - 3) * j + (j * 2) + this.horseContainerBG.height - 34,
								this.horseContainerBG.width * 0.62, 32,
							);
						}
					}

					// Other players text
					gameEngine.ctx.font = `${30 * this.scaleX}px Time New Romen`;
					gameEngine.ctx.fillStyle = "black";
					let countV = 0;
					for (let i = 0; i < 5; i++) {
						for (let j = 5 - i; j < 5; j++) {
							gameEngine.ctx.fillText(
								this.betTableOffset.playerData[countV].userName,
								startX + (this.horseContainerBG.width - 3) * i + 2 * i + 2 + (this.horseContainerBG.width - 2) / 3 + 5,
								startY + (this.horseContainerBG.height - 3) * j + (j * 2) + 31
							);

							gameEngine.ctx.fillText(
								this.betTableOffset.playerData[countV].gold,
								startX + (this.horseContainerBG.width - 3) * i + 2 * i + 2 + (this.horseContainerBG.width - 2) / 3 + 5,
								startY + (this.horseContainerBG.height - 3) * j + (j * 2) + this.horseContainerBG.height - 34 + 25
							);
							countV++;
						}
					}
				}

				// Draw bet count
				gameEngine.ctx.fillStyle = "white";
				gameEngine.ctx.font = `${45 * this.scaleX}px Ariel`;
				let count = 0;
				for (let i = 0; i < 5; i++) {
					for (let k = 0; k < 5 - i; k++) {
						gameEngine.ctx.fillText(
							this.betTableOffset.betPoint[count],
							startX + (this.horseContainerBG.width - 3) * i + 2 * i + 2 + 5,
							startY + (this.horseContainerBG.height - 3) * k + (k * 2) + 2 + this.horseContainerBG.height * 0.425);
						count++;
					}
				}

				// Draw ODDs
				if (gameEngine.isDevelop) {
					count = 0;
					for (let i = 0; i < 5; i++) {
						for (let k = 0; k < 5 - i; k++) {
							gameEngine.ctx.fillText(
								this.betTableOffset.ODDs[count],
								startX + 2 * i + 2 + (this.horseContainerBG.width - 3) * i + 5,
								startY + k * 2 + 2 + (this.horseContainerBG.height - 3) * k + this.horseContainerBG.height * 0.925);
							count++;
						}
					}
				} else {
					if (gameEngine.currentGame) {
						count = 0;
						gameEngine.ctx.fillStyle = "yellow";
						for (let i = 0; i < 5; i++) {
							for (let k = 0; k < 5 - i; k++) {
								gameEngine.ctx.fillText(
									gameEngine.currentGame.na[count],
									startX + 2 * i + 2 + (this.horseContainerBG.width - 3) * i + 5,
									startY + k * 2 + 2 + (this.horseContainerBG.height - 3) * k + this.horseContainerBG.height * 0.925);
								count++;
							}
						}
					}
				}


				//historyBG
				gameEngine.ctx.fillStyle = "red";
				
				gameEngine.ctx.drawImage(
					this.historyTableOffset.img,
					this.historyTableOffset.x,
					this.historyTableOffset.y,
					this.historyTableOffset.width,
					this.historyTableOffset.height
				);

				// gameEngine.ctx.fillRect(
				// 	this.historyTableOffset.x,
				// 	this.historyTableOffset.y,
				// 	this.historyTableOffset.width,
				// 	this.historyTableOffset.height);

				gameEngine.ctx.drawImage(
					this.imgCup,
					this.historyTableOffset.x + this.historyTableOffset.width - this.imgCup.width / 2,
					this.historyTableOffset.y - this.imgCup.height / 2,
				);

				gameEngine.ctx.font = "50px Time New Romen";
				gameEngine.ctx.fillStyle = "white";
				gameEngine.ctx.fillText(
					this.historyTableOffset.tiltle,
					this.historyTableOffset.x + 33,
					this.historyTableOffset.y + 65,
				);

				gameEngine.ctx.font = "80px Time New Romen";
				if (gameEngine.history) {
					for (var i = 0; i < 4; i++) {
						const result = Ultilities.getWinIds(gameEngine.history[i].id);
						gameEngine.ctx.fillText(
							`${result.first} - ${result.second}`,
							this.historyTableOffset.x + 60,
							this.historyTableOffset.y + this.historyTableOffset.height / 3 + i * 90,
						);
					}
				}

				// Clock
				gameEngine.ctx.drawImage(
					this.clockBackground,
					this.betTableOffset.x + this.betTableOffset.width + 5,
					this.betTableOffset.y,
					150, 150
				);

				gameEngine.ctx.font = "80px Time New Romen";
				gameEngine.ctx.fillStyle = "black";
				// console.log(`${gameEngine.timeCircle} ===== ${gameEngine.currentCountDown}`)
				let timeCountDown = 0
				if (gameEngine.isDevelop)
					timeCountDown = Math.floor((this.clientCountDown - Date.now()) / 1000);
				else
					timeCountDown = Math.floor((gameEngine.timeCircle - (Date.now() - gameEngine.timeBeginTurn)) / 1000);
				gameEngine.ctx.fillText(
					`${timeCountDown < 0 ? 0 : timeCountDown}`,
					this.betTableOffset.x + this.betTableOffset.width + 60,
					this.betTableOffset.y + 95
				);

				//userBG
				gameEngine.ctx.fillStyle = "red";
				gameEngine.ctx.fillRect(
					this.userInfoOffset.x,
					this.userInfoOffset.y,
					this.userInfoOffset.width,
					this.userInfoOffset.height
				);

				gameEngine.ctx.fillStyle = "white";
				gameEngine.ctx.fillRect(
					this.userInfoOffset.x + this.userInfoOffset.width / 2.7,
					this.userInfoOffset.y + 10,
					220, 50,
				);

				gameEngine.ctx.fillRect(
					this.userInfoOffset.x + this.userInfoOffset.width / 2.7,
					this.userInfoOffset.y + this.userInfoOffset.height / 2 + 13,
					220, 50,
				);

				gameEngine.ctx.drawImage(
					this.imgCoin,
					this.userInfoOffset.x + this.userInfoOffset.width / 2.7 - this.imgCoin.width / 4,
					this.userInfoOffset.y + 4,
					65, 65,
				);

				// Draw user gold and username
				gameEngine.ctx.fillStyle = "black";
				gameEngine.ctx.font = "30px Times new roman";
				gameEngine.ctx.fillText(
					gameEngine.money,
					this.userInfoOffset.x + this.userInfoOffset.width / 3 + this.imgCoin.width * 0.5,
					this.userInfoOffset.y + 15 + this.imgCoin.height / 4
				);

				gameEngine.ctx.fillText(
					gameEngine.username,
					this.userInfoOffset.x + this.userInfoOffset.width / 3 + this.imgCoin.width * 0.5,
					this.userInfoOffset.y + this.imgCoin.height - 5
				);

				// Draw holder
				gameEngine.ctx.drawImage(
					this.imgChipHolder,
					this.holderOffset.x,
					this.holderOffset.y,
					this.holderOffset.width, this.holderOffset.height
				)

				let scaleUpValue = 1;
				let moveValue = 0;
				// Draw chips
				for (let i = 0; i < 27; i++) {
					// Scale and move chip
					let chipX = this.holderOffset.chipStart + this.chipOffset * i + this.holderOffset.chipSize * i + this.slidePage;
					if (this.holderOffset.chipStart > chipX || chipX > (this.holderOffset.x + this.holderOffset.width - 120))
						continue;
					let chipY = this.holderOffset.y + this.holderOffset.height / 5.5;
					let chipSize = this.holderOffset.chipSize;
					if (i == this.chipHoldingId) {
						if (this.chipAnimation.scale.isScaleUp) {
							scaleUpValue = this.chipAnimation.scale.value;
							moveValue = this.chipOffset;
						}
						chipX = Ultilities.lerp(this.chipAnimation.move.currentPosX, chipX - moveValue, this.chipAnimation.move.speed);
						chipY = Ultilities.lerp(this.chipAnimation.move.currentPosY, chipY - moveValue + 5, this.chipAnimation.move.speed);
						chipSize = Ultilities.lerp(this.chipAnimation.scale.currentSize, this.holderOffset.chipSize * scaleUpValue, this.chipAnimation.scale.speed);
						this.chipAnimation.scale.currentSize = chipSize;
						this.chipAnimation.move.currentPosX = chipX;
						this.chipAnimation.move.currentPosY = chipY;

						if (this.chipAnimation.scale.currentSize >= (this.holderOffset.chipSize * scaleUpValue - 5))
							this.chipAnimation.scale.isScaleUp = false
						if (this.chipAnimation.scale.currentSize <= (this.holderOffset.chipSize + 5))
							this.chipAnimation.scale.isScaleUp = true
					}

					gameEngine.ctx.drawImage(
						this.imgChips[i],
						chipX,
						chipY,
						chipSize, chipSize
					)
				}

				// Move chip to target 
				for (let i = 0; i < this.moveChipToBet.chips.length; i++) {
					const chipX = Ultilities.lerp(
						this.moveChipToBet.chips[i].currentPosX,
						this.moveChipToBet.chips[i].targetPosX,
						this.moveChipToBet.speed, this.holderOffset.chipSize / 2, this.holderOffset.chipSize / 2);
					const chipY = Ultilities.lerp(
						this.moveChipToBet.chips[i].currentPosY,
						this.moveChipToBet.chips[i].targetPosY,
						this.moveChipToBet.speed, this.holderOffset.chipSize / 2, this.holderOffset.chipSize / 2);

					gameEngine.ctx.drawImage(
						this.imgChips[this.moveChipToBet.chips[i].id],
						chipX,
						chipY,
						this.holderOffset.chipSize,
						this.holderOffset.chipSize);

					this.moveChipToBet.chips[i].currentPosX = chipX;
					this.moveChipToBet.chips[i].currentPosY = chipY;
					if (this.moveChipToBet.chips[i].currentPosY <= this.moveChipToBet.chips[i].targetPosY + 25) {
						this.moveChipToBet.chips.splice(i, 1);
					}
				}
				gameEngine.ctx.drawImage(
					this.imgArrows.left,
					this.holderOffset.arrow,
					this.holderOffset.y + this.holderOffset.height / 5.5,
					this.imgArrows.width,
					this.imgArrows.height
				);

				gameEngine.ctx.drawImage(
					this.imgArrows.right,
					this.holderOffset.x + this.holderOffset.width - this.imgArrows.width - this.horseOffset,
					this.holderOffset.y + this.holderOffset.height / 5.5,
					this.imgArrows.width,
					this.imgArrows.height
				);
			}
			onClick() {
				// Mouse on chip board
				if (this.holderOffset.x <= this.mouseX && this.mouseX <= (this.holderOffset.x + this.holderOffset.width) &&
					this.holderOffset.y <= this.mouseY && this.mouseY <= (this.holderOffset.y + this.holderOffset.height)) {

					if (this.mouseX >= this.holderOffset.arrow &&
						this.mouseX <= this.holderOffset.arrow + this.imgArrows.width &&
						this.mouseY >= this.holderOffset.y + this.holderOffset.height / 5.5 &&
						this.mouseY <= this.holderOffset.y + this.holderOffset.height / 5.5 + this.imgArrows.height) {
						// Left arrow
						if (this.pageValue.currentPageNumber > 1) {
							this.slidePage += this.pageValue.valueEachPage;
							this.pageValue.currentPageNumber--;
							this.chipHoldingId = 7 * (this.pageValue.currentPageNumber - 1);

							this.chipAnimation.move.currentPosX = this.holderOffset.chipStart;
							this.chipAnimation.move.currentPosY = this.holderOffset.y + this.holderOffset.height / 5.5;
						}
					} else if (this.mouseX >= this.holderOffset.x + this.holderOffset.width - (this.imgArrows.width - 30) &&
						this.mouseX <= this.holderOffset.x + this.holderOffset.width - 30 &&
						this.mouseY >= this.holderOffset.y + this.holderOffset.height / 5.5 &&
						this.mouseY <= this.holderOffset.y + this.holderOffset.height / 5.5 + this.imgArrows.height) {
						if (this.pageValue.currentPageNumber < this.pageValue.maxPage) {
							this.slidePage -= this.pageValue.valueEachPage;
							this.pageValue.currentPageNumber++;
							this.chipHoldingId = 7 * (this.pageValue.currentPageNumber - 1);

							this.chipAnimation.move.currentPosX = this.holderOffset.chipStart;
							this.chipAnimation.move.currentPosY = this.holderOffset.y + this.holderOffset.height / 5.5;
						}
					} else {
						for (let i = 0; i < 7; i++) {
							const chipX = this.holderOffset.chipStart + this.chipOffset * i + this.holderOffset.chipSize * i;
							const chipY = this.holderOffset.y + this.holderOffset.height / 5.5;
							if (chipX <= this.mouseX && this.mouseX <= chipX + this.holderOffset.chipSize &&
								chipY <= this.mouseY && this.mouseY <= chipY + this.holderOffset.chipSize) {
								if (this.chipHoldingId != i) {
									this.chipHoldingId = i + 7 * (this.pageValue.currentPageNumber - 1);
									this.chipAnimation.move.currentPosX = chipX;
									this.chipAnimation.move.currentPosY = chipY;
								}
							}
						}
					}
				} else if (this.betTableOffset.x <= this.mouseX && this.mouseX <= this.betTableOffset.x + this.betTableOffset.width &&
					this.betTableOffset.y <= this.mouseY && this.mouseY <= this.betTableOffset.y + this.betTableOffset.height) {
					const offSetStartX = this.betTableOffset.x + this.horseOffset + this.horseContainerBG.width + 1;
					const offSetEndX = offSetStartX + this.horseContainerBG.width - 2;
					const offSetStartY = this.betTableOffset.y + this.horseOffset / 2 + this.horseContainerBG.height + 1;
					const offSetEndY = offSetStartY + this.horseContainerBG.height - 2;

					// Bet table
					let count = 0;
					for (let i = 0; i < 5; i++) {
						for (let k = 0; k < 5 - i; k++) {
							if (offSetStartX + (this.horseContainerBG.width * i) <= this.mouseX && this.mouseX <= offSetEndX + (this.horseContainerBG.width * i) &&
								offSetStartY + (this.horseContainerBG.height * k) <= this.mouseY && this.mouseY <= offSetEndY + (this.horseContainerBG.height * k)) {
								if (gameEngine.isDevelop) {
									this.moveChipToBet.chips.push({
										id: this.chipHoldingId,
										currentPosX: this.holderOffset.chipStart + this.chipOffset * (this.chipHoldingId - 7 * (this.pageValue.currentPageNumber - 1)) + this.holderOffset.chipSize * (this.chipHoldingId - 7 * (this.pageValue.currentPageNumber - 1)),
										currentPosY: this.holderOffset.y + this.holderOffset.height / 5.5,
										targetPosX: this.randomPosition(offSetStartX + (this.horseContainerBG.width * i) - 35, offSetEndX + (this.horseContainerBG.width * i) - 35),
										targetPosY: this.randomPosition(offSetStartY + (this.horseContainerBG.height * k) - 50, offSetEndY + (this.horseContainerBG.height * k) - 50)
									});
									this.betTableOffset.betPoint[count] += this.chipsData[this.chipHoldingId].value;
									return;
									count++;
								} else
									basicWS.doBet(count, this.chipsData[this.chipHoldingId].value);
								return;
							}
							count++;
						}
					}
				}
			}
			randomPosition(min, max) {
				return Math.random() * (max - min) + min;
			}
			onBetSuccess(_username, _indexBet, _lostmoney, _currentMoney, _listDesk, _currentPosX = -1, _currentPosY = -1) {
				const offSetStartX = this.betTableOffset.x + this.horseOffset + this.horseContainerBG.width + 1;
				const offSetEndX = offSetStartX + this.horseContainerBG.width - 2;
				const offSetStartY = this.betTableOffset.y + this.horseOffset / 2 + this.horseContainerBG.height + 1;
				const offSetEndY = offSetStartY + this.horseContainerBG.height - 2;

				let count = 0;
				for (let i = 0; i < 5; i++) {
					for (let k = 0; k < 5 - i; k++) {
						if (count == _indexBet) {
							if (_currentPosX != -1 && _currentPosY != -1) {
								this.moveChipToBet.chips.push({
									id: this.chipHoldingId,
									currentPosX: _currentPosX,
									currentPosY: _currentPosY,
									targetPosX: this.randomPosition(offSetStartX + (this.horseContainerBG.width * i) - 35, offSetEndX + (this.horseContainerBG.width * i) - 35),
									targetPosY: this.randomPosition(offSetStartY + (this.horseContainerBG.height * k) - 50, offSetEndY + (this.horseContainerBG.height * k) - 50)
								});
							}else{
								this.moveChipToBet.chips.push({
									id: this.chipHoldingId,
									currentPosX: this.holderOffset.chipStart + this.chipOffset * (this.chipHoldingId - 7 * (this.pageValue.currentPageNumber - 1)) + this.holderOffset.chipSize * (this.chipHoldingId - 7 * (this.pageValue.currentPageNumber - 1)),
									currentPosY: this.holderOffset.y + this.holderOffset.height / 5.5,
									targetPosX: this.randomPosition(offSetStartX + (this.horseContainerBG.width * i) - 35, offSetEndX + (this.horseContainerBG.width * i) - 35),
									targetPosY: this.randomPosition(offSetStartY + (this.horseContainerBG.height * k) - 50, offSetEndY + (this.horseContainerBG.height * k) - 50)
								});
							}

							this.betTableOffset.betPoint[count] = _listDesk[_indexBet];
							return;
						}
						count++;
					}
				}
			}

			onOtherPlayerBet(userIndex, _username, _indexBet, _lostmoney, _currentMoney, _listDesk) {
				// Draw other player background
				let count = 0;
				const startX = this.betTableOffset.x + this.horseOffset + this.horseContainerBG.width
				const startY = this.betTableOffset.y + this.horseOffset / 2 + this.horseContainerBG.height
				let startChipX = 0;
				let startChipY = 0;
				gameEngine.ctx.fillStyle = "blue";
				for (let i = 0; i < 5; i++) {
					for (let j = 5 - i; j < 5; j++) {
						if (count == userIndex) {
							startChipX = startX + (this.horseContainerBG.width - 3) * i + 2 * i + 2 + this.horseContainerBG.width / 2;
							startChipY = startY + (this.horseContainerBG.height - 3) * j + (j * 2) + 2 + this.horseContainerBG.height / 2;
							isFoundPlayer = true;
							onBetSuccess(_username, _indexBet, _lostmoney, _currentMoney, _listDesk, startChipX, startChipY)
							return;
						}
						count++;
					}
				}
			}
			onUpdateBetTableData(_username, _indexBet, _lostmoney, _currentMoney, _listDesk) {
				let isContainPlayer = false;
				// Check player list and get the player data
				for (let i = 0; i < this.betTableOffset.playerData.length; i++) {
					if (this.betTableOffset.playerData[i].userName == _username) {
						isContainPlayer = true;
						break;
					}
				}

				// push data to playerData to draw it on Canvas
				if (!isContainPlayer) {
					this.betTableOffset.playerData.push({
						userName: _username,
						gold: _currentMoney
					});
				}

				onOtherPlayerBet(_username, _indexBet, _lostmoney, _currentMoney, _listDesk);
				let count = 0;
				for (let i = 0; i < 5; i++) {
					for (let k = 0; k < 5 - i; k++) {
						if (count == _indexBet) {
							this.betTableOffset.betPoint[count] = _listDesk[_indexBet];
							return;
						}
						count++;
					}
				}
			}
		}


		basicWS.onPlayerBet = (_username, _indexBet, _lostmoney, _currentMoney, _listDesk) => {
			console.log("username(" + _username + ") + index(" + _indexBet + ") + bet(" + _lostmoney + ") money(" + _currentMoney + ") listDesk(" + _listDesk + ")");
			if (gameEngine.gameloop.onBetSuccess && _username == gameEngine.username) {
				gameEngine.money = _currentMoney
				gameEngine.gameloop.onBetSuccess(_username, _indexBet, _lostmoney, _currentMoney, _listDesk);
			} else
				gameEngine.gameloop.onUpdateBetTableData(_username, _indexBet, _lostmoney, _currentMoney, _listDesk);
		};
		basicWS.onBetError = (_idCMD, strError) => {
			console.log("_idCMD(" + _idCMD + ") : " + strError);
		};
		basicWS.onFinishGame = (resultIndex, winMoney, lastMoney, newScore) => {
			const result = Ultilities.getWinIds(resultIndex);
			gameEngine.changeScene(new SceneGamePlay());
			gameEngine.gameloop.firstHorseId = result.first;
			gameEngine.gameloop.secondHorseId = result.second;
			gameEngine.currentGame.na = newScore;
			console.log(`Win Id: ${gameEngine.gameloop.firstHorseId} - ${gameEngine.gameloop.secondHorseId}, win index: ${resultIndex}`)
			console.log("Kết quả : " + resultIndex + "	(" + winMoney + "," + lastMoney + ") ---> " + newScore);
			if (lastMoney)
				gameEngine.money = lastMoney;
		};
		basicWS.onGameInfo = (money, currentGame, listBet, timeLeft, timeCircle, listHistory) => {
			gameEngine.isDevelop = false;
			console.log("======================>Dev with server<==================");
			gameEngine.money = money;
			gameEngine.history = listHistory;
			gameEngine.currentGame = currentGame;
			gameEngine.timeBeginTurn = Date.now() - (timeCircle - timeLeft);
			gameEngine.timeCircle = timeCircle;
			// console.log(timeLeft + "===============" + timeCircle);
			// console.log(money);
			// console.log("List Bet : " + listBet);
			// console.log(currentGame);
			// console.log(listHistory);
			// console.log("Kết quả trận 4 : " + listHistory[4][F.ID]);
			// console.log("Tỷ số trận 4 : " + listHistory[4][F.NEW_ANNOUNCE]);
		};
		gameEngine.changeScene(new SceneLogin());
		// gameEngine.changeScene(new SceneGamePlay());
		// basicWS.onSuccess = () => {
		// 	for (let i = 0; i < 15; i++)
		// 	basicWS.doBet(i, i + 1);
		// };
		basicWS.start("192.168.55.103", 8892);
		console.log("Muốn tắt log nhấn phím thì override lại method nhấn phím trong Scene");
	</script>
</body>

</html>