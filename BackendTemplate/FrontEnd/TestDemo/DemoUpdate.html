<!DOCTYPE html>
<html>

<head>
    <title>Trò chơi đua ngựa</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        #track {
            width: 100%;
            height: 600px;
            border: 1px solid #000;
            position: relative;
            overflow: hidden;
        }

        .start {
            position: absolute;
            width: 10%;
            height: 100%;
            left: 0%;
            background: url('../UI/map/Untitled-1_0000_9.png') no-repeat;
        }

        .end {
            position: absolute;
            width: 10%;
            height: 100%;
            right: 0%;
            background: url('../UI/map/Untitled-1_0001_Layer-17.png') no-repeat;
        }

        .background {
            position: absolute;
            width: 100%;
            height: 100%;
            background: url('../UI/map/range.png');
            /* animation: none; moveBackground 5s linear infinite */
        }
    
         
        @keyframes moveBackground {
            0% {
                background-position: 100% 0;
            }
            100% {
                background-position: 0 0;
            }
        }
    
        .horse {
            width: 80px;
            height: 75px;
            background: url('../Animation/Idle/128x128/Idle_Frame1.png') no-repeat;
            background-size: cover;
            position: absolute;
            top: 0;
        }

        button {
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <button onclick="startRace()">Bắt đầu đua</button>
    <div id="track">
        <div class="background" id="BGA"></div>
        <div class="start"></div>
        <div class="end"></div>
    </div>

    <script>
        
        const resultGame = {
            "horseId": 3
        }
        let backgroundPosition = 0;
        let currentFrame = 1;
        let playIdle;
        const horses = [];
            
        function addHorse() {
            for (let i = 0; i < 9; i++){
                const newHorse = document.createElement('div');
                newHorse.className = 'horse';
                newHorse.id = 'horse' + horses.length;
                newHorse.style.left = '0';
                newHorse.style.top = horses.length * 60 + 'px';
                const track = document.getElementById('track');
                track.appendChild(newHorse);
                horses.push(newHorse);
            }

            playIdle = setInterval(() => {
                if (currentFrame > 7) {
                    currentFrame = 1;
                }
                const frameUrl = `../Animation/Idle/128x128/Idle_Frame${currentFrame}.png`;

                for (let i = 0; i < horses.length; i++){
                    horses[i].style.backgroundImage = `url(${frameUrl})`;
                }
                currentFrame++;
            }, 100);
        }
        addHorse();

        // STAR RACE
        function startRace() {

            // Loop Background
            const backGround = document.getElementById('BGA');
            backGround.style.animation = 'moveBackground 5s linear infinite';
            
            clearInterval(playIdle);
            for (let i = 0; i < horses.length; i++) {
                const horse = document.getElementById('horse' + i);
                if (horse) {
                    horses[horses.length - 1].style.animationDuration = (0.6 * Math.random()) + 's';
                } else {
                    console.error('Phần tử ngựa không tồn tại với id: horse' + i);
                }
            }

            const track = document.getElementById('track');
            const trackWidth = track.offsetWidth;
            console.log(trackWidth);

            const frameCount = 11; // số frames 
            let currentFrame = 1;
            const updateAnimation = setInterval(() => {
                for (let i = 0; i < horses.length; i++) {
                    const horse = document.getElementById('horse' + i);
                    if (currentFrame > frameCount) {
                        currentFrame = 1;
                    }
                    const frameUrl = `../Animation/Run/128x128/Run_Frame${currentFrame}.png`;
                    horse.style.backgroundImage = `url(${frameUrl})`;
                    currentFrame++;
                }
            }, 100);
            

            const raceInterval = setInterval(() => {
                for (let i = 0; i < horses.length; i++) {
                    let horsePosition = parseFloat(horses[i].style.left) || 0;
                    horsePosition += Math.random() * 10;
                    horses[i].style.left = horsePosition + 'px';

                    if (horsePosition >= trackWidth) {
                        clearInterval(raceInterval);
                        clearInterval(updateAnimation);
                        alert("Ngựa " + (i + 1) + " kết thúc đua!");
                        resetHorsesPosition();
                        break;
                    }
                }
            }, 0);
        }

        //RS HOURSE POSSITION
        function resetHorsesPosition() {
            for (let i = 0; i < horses.length; i++) {
                const horse = document.getElementById('horse' + (i));
                horse.style.left = '0';
            }

            playIdle = setInterval(() => {
                const backGround = document.getElementById('BGA');
                backGround.style.animation = 'none';
                if (currentFrame > 7) {
                    currentFrame = 1;
                }
                const frameUrl = `../Animation/Idle/128x128/Idle_Frame${currentFrame}.png`;

                for (let i = 0; i < horses.length; i++){
                    horses[i].style.backgroundImage = `url(${frameUrl})`;
                }
                currentFrame++;
            }, 100);
            
        }
    </script>
</body>

</html>