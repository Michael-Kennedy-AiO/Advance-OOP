<!DOCTYPE html>
<html>

<head>
    <title>Trò chơi đua ngựa</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        #track {
            width: 100%;
            height: 500px;
            border: 1px solid #000;
            position: relative;
            overflow: hidden;
        }

        .start {
            position: absolute;
            width: 10%;
            height: 100%;
            left: 0%;
            background: url('../UI/map/Untitled-1_0000_9.png') no-repeat;
        }

        .end {
            position: absolute;
            width: 10%;
            height: 100%;
            right: 0%;
            background: url('../UI/map/Untitled-1_0001_Layer-17.png') no-repeat;
        }

        .background {
            position: absolute;
            width: 100%;
            height: 100%;
            background: url('../UI/map/range.png') repeat;
        }


        .horse {
            width: 80px;
            height: 75px;
            background: url('../Animation/Idle/128x128/Idle_Frame1.png') no-repeat;
            background-size: cover;
            position: absolute;
            top: 0;
        }

        button {
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <button onclick="addHorse()">Thêm ngựa</button>
    <button onclick="startRace()">Bắt đầu đua</button>
    <div id="track">
        <div class="background"></div>
        <div class="start"></div>
        <div class="end"></div>
    </div>

    <script>
        const resultGame = {
            "horseId": 3
        }
        let backgroundPosition = 0;
        let horseCount = 0;

        function addHorse() {
            const newHorse = document.createElement('div');
            newHorse.className = 'horse';
            newHorse.id = 'horse' + horseCount;
            newHorse.style.left = '0';
            newHorse.style.top = horseCount * 60 + 'px';
            horseCount++;
            console.log(horseCount);
            const track = document.getElementById('track');
            track.appendChild(newHorse);

            setInterval(() => {
                console.log("aaaaa")
                let currentFrame = 1;
                if (currentFrame > 6) {
                    currentFrame = 1;
                }

                const frameUrl = `../Animation/Idle/128x128/Idle_Frame${currentFrame}.png`;
                newHorse.style.backgroundImage = `url(${frameUrl})`;
                currentFrame++;
                console.log("aaaaa" + currentFrame)
            }, 100);
        }
        function startRace() {
            if (horseCount < 2) {
                alert('Hãy thêm ít nhất hai ngựa trước khi bắt đầu đua.');
                return;
            }

            const horses = [];
            for (let i = 0; i < horseCount; i++) {
                const horse = document.getElementById('horse' + i);
                if (horse) {
                    horses.push(horse);
                    horses[horses.length - 1].style.animationDuration = (0.6 * Math.random()) + 's';
                } else {
                    console.error('Phần tử ngựa không tồn tại với id: horse' + i);
                }
            }
            const track = document.getElementById('track');
            const trackWidth = track.offsetWidth;
            console.log(trackWidth);

            const frameCount = 11; // số frames 
            let currentFrame = 1;
            const updateAnimation = setInterval(() => {
                for (let i = 0; i < horseCount; i++) {
                    const horse = document.getElementById('horse' + i);
                    if (currentFrame > frameCount) {
                        currentFrame = 1;
                    }
                    const frameUrl = `../Animation/Run/128x128/Run_Frame${currentFrame}.png`;
                    horse.style.backgroundImage = `url(${frameUrl})`;
                    currentFrame++;
                }
            }, 100);

            const raceInterval = setInterval(() => {
                for (let i = 0; i < horseCount; i++) {
                    let horsePosition = parseFloat(horses[i].style.left) || 0;
                    horsePosition += Math.random() * 10;
                    horses[i].style.left = horsePosition + 'px';

                    if (horsePosition >= trackWidth) {
                        clearInterval(raceInterval);
                        clearInterval(updateAnimation);
                        alert("Ngựa " + (i + 1) + " kết thúc đua!");
                        resetHorsesPosition();
                        break;
                    }
                }
            }, 0);
        }
        function resetHorsesPosition() {
            for (let i = 0; i < horseCount; i++) {
                const horse = document.getElementById('horse' + (i));
                horse.style.left = '0';
            }
        }
    </script>
</body>

</html>